# Author: progamerrox@github
# Creation date: 12/22/2021

# READ ALL THE INSTRUCTIONS TILL THE END TO NOT MISS SOMETHING CRUCIAL

# Installation script for a Pi-Hole + Unbound + Tailscale + Searx + Fail2Ban on an Ubuntu Server

Notes: 
1. These steps are for creating a new server from scratch. If you are using an existing server for this script, you may skip a few steps that are unneccessary. Read through the installation script to ensure that there are no conflicts.
2. We'll be using a VPS server for this example.
3. Bash commands will have a $ before them.
4. Additional information (comments) are marked by a #

Steps:

1. First, create a new Ubuntu 20.04 LTS server (# Basic setup + creating new user):
$ ssh root@IP     #(accept the fingerprint)
$ apt update -y
$ apt upgrade -y
$ adduser username    #(change username to anything else)
$ usermod -aG sudo username
$ cd /home/username
$ mkdir .ssh
$ nano .ssh/authorized_keys #(add your device's public key to authorize SSH)
$ exit

2. SSH into the instance using the new user (First step for users installing this on an existing server):
$ ssh username@IP

3. Installation process:
$ cd $HOME
$ nano install.sh     #(Copy the instructions from the install.sh file) (CTRL+O and ENTER and CTRL+X to save and exit)
$ chmod +x install.sh
$ ./install_pihole.sh
# Additional information:
# (Follow instructions on Pi-Hole setup. Select Cloudflare as DNS and enable web portal)
# (Login to your tailscale account through the outputted link to connect your server)

4. Disable Cloudflare and Enable Unbound in Pi-Hole:
Connect your device to the tailscale network. Instructions can be found at https://tailscale.com/download
Log in to the Pi-Hole admin portal (Address should have been outputted at the end of the bash script: http://$(tailscale_ip):85/admin) -> Settings -> DNS -> De-select cloudflare and select custom ip = 127.0.0.1#5335

5. NOTE:
The server's SSH port has been changed. New SSH port = 476. SSH Access command = ssh -p 476 username@tailscale_IP
(UFW Rule prevents users from accessing SSH outside the tailscale network for security reasons) (This can be changed with "sudo ufw allow 476/tcp")
(Port 476 was chosen at random. You may choose any port and change it to your liking in the installation script. Be sure to change all instances of "476" in the script.)

IMPORTANT:
Commands to run after reboot to start searx:
$ cd searx
$ export PORT=8080
$ sudo docker run --rm \
             -d -p ${PORT}:8080 \
             -v "${PWD}/searxng:/etc/searxng" \
             -e "BASE_URL=http://localhost:$PORT/" \
             -e "INSTANCE_NAME=Searx" \
             searxng/searxng
